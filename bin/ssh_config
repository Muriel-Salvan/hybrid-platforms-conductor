#!/usr/bin/env ruby
require 'hybrid_platforms_conductor/nodes_handler'
require 'hybrid_platforms_conductor/ssh_executor'
require 'optparse'

nodes_handler = HybridPlatformsConductor::NodesHandler.new
ssh_executor = HybridPlatformsConductor::SshExecutor.new(nodes_handler: nodes_handler)
ssh_exec = 'ssh'
OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"
  opts.separator ''
  opts.separator 'Main options:'
  opts.on('-h', '--help', 'Display help and exit') do
    puts opts
    exit 0
  end
  opts.on('-x', '--ssh-exec FILE_PATH', "Path to the SSH executable to be used. Useful to give default options (especially with GIT_SSH). Defaults to #{ssh_exec}.") do |file_path|
    ssh_exec = file_path
  end
  nodes_handler.options_parse(opts)
  ssh_executor.options_parse(opts, parallel: false)
end.parse!
ssh_executor.validate_params
raise "Unknown options: #{ARGV.join(' ')}" unless ARGV.empty?

puts ssh_executor.ssh_config(ssh_exec: ssh_exec)
