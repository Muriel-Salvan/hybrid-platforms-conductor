#!/usr/bin/env ruby
require 'hybrid_platforms_conductor/nodes_handler'
require 'hybrid_platforms_conductor/ssh_executor'
require 'hybrid_platforms_conductor/cmd_runner'
require 'hybrid_platforms_conductor/deployer'
require 'optparse'

# Logger.new(STDOUT)

test_host = nil
cmd_runner = HybridPlatformsConductor::CmdRunner.new
nodes_handler = HybridPlatformsConductor::NodesHandler.new
ssh_executor = HybridPlatformsConductor::SshExecutor.new(cmd_runner: cmd_runner, nodes_handler: nodes_handler)
deployer = HybridPlatformsConductor::Deployer.new(cmd_runner: cmd_runner, ssh_executor: ssh_executor)
OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"
  opts.separator ''
  opts.separator 'Main options:'
  opts.on('-h', '--help', 'Display help and exit') do
    puts opts
    exit 0
  end
  opts.on('-n', '--host-name HOST_NAME', 'Run the command on a specific host.') do |host_name|
    test_host = host_name
  end
  nodes_handler.options_parse(opts)
  ssh_executor.options_parse(opts, parallel: false)
  deployer.options_parse(opts, parallel_switch: false)
end.parse!
ssh_executor.validate_params
deployer.validate_params
raise 'No test host specified. Please use --host option to set it.' if test_host.nil? || test_host.empty?
raise "Unknown host name: #{test_host}" unless nodes_handler.known_hostnames.include?(test_host)
raise "Unknown options: #{ARGV.join(' ')}" unless ARGV.empty?

ssh_executor.dump_conf

# Make sure we always use why-run
deployer.use_why_run = true
deployer.deploy_for(test_host)
